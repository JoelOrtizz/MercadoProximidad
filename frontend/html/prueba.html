<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prueba editar productos</title>
    <link rel="stylesheet" href="../css/nav.css" />
    <style>
      .page {
        max-width: 1100px;
        margin: 0 auto;
        padding: 24px;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
      }
      th,
      td {
        border: 1px solid #e5e7eb;
        padding: 10px;
        vertical-align: top;
      }
      th {
        background: #f8fafc;
        text-align: left;
        font-weight: 700;
      }
      input[type="text"],
      input[type="number"],
      textarea {
        width: 100%;
        box-sizing: border-box;
        padding: 6px 8px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
      }
      textarea {
        min-height: 68px;
        resize: vertical;
      }
      .row-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      button {
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        background: #fff;
        cursor: pointer;
      }
      button.primary {
        background: #111827;
        border-color: #111827;
        color: #fff;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .img {
        width: 88px;
        height: 66px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        background: #f3f4f6;
        display: block;
        margin-bottom: 8px;
      }
      .muted {
        color: #6b7280;
        font-size: 12px;
      }
      .error {
        margin-top: 12px;
        color: #b91c1c;
      }
    </style>
  </head>
  <body>
    <div id="globalNav"></div>

    <main class="page">
      <h1>Prueba: editar productos</h1>
      <p class="muted">
        Requiere iniciar sesión (cookie <code>access_token</code>) para poder editar.
      </p>

      <div style="overflow: auto">
        <table aria-label="Tabla de productos">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Categoria</th>
              <th>Tipo</th>
              <th>Stock</th>
              <th>Precio</th>
              <th>Duracion</th>
              <th>Descripcion</th>
              <th>Imagen</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div id="error" class="error" role="alert" aria-live="polite"></div>
    </main>

    <script src="../js/main.js"></script>
    <script src="../js/nav.js"></script>
    <script>
      const rowsEl = document.getElementById("rows");
      const errorEl = document.getElementById("error");

      function backendOriginFromApiUrl() {
        if (typeof window.API_URL === "string" && window.API_URL) {
          return window.API_URL.replace(/\/api\/?$/, "");
        }
        if (typeof API_URL === "string" && API_URL) {
          return API_URL.replace(/\/api\/?$/, "");
        }
        return "http://localhost:3000";
      }

      const BACKEND_ORIGIN = backendOriginFromApiUrl();

      function resolveImageSrc(value) {
        if (!value) return "";
        if (/^https?:\/\//i.test(value)) return value;
        return `${BACKEND_ORIGIN}/uploads/${encodeURIComponent(value)}`;
      }

      function setRowEditing(tr, editing) {
        tr.dataset.editing = editing ? "1" : "0";
        tr.querySelectorAll("input[data-field], textarea[data-field]").forEach((el) => {
          const isFile = el.type === "file";
          el.disabled = !editing || isFile === false ? !editing : !editing;
        });
        const fileInput = tr.querySelector('input[type="file"][data-field="imagen"]');
        if (fileInput) fileInput.disabled = !editing;

        const btnEdit = tr.querySelector("button[data-action='edit']");
        const btnSave = tr.querySelector("button[data-action='save']");
        const btnCancel = tr.querySelector("button[data-action='cancel']");
        if (btnEdit) btnEdit.disabled = editing;
        if (btnSave) btnSave.disabled = !editing;
        if (btnCancel) btnCancel.disabled = !editing;
      }

      function setRowBusy(tr, busy) {
        tr.querySelectorAll("button").forEach((b) => (b.disabled = busy));
      }

      function makeCellInput(type, field, value) {
        const input = document.createElement("input");
        input.type = type;
        input.value = value == null ? "" : String(value);
        input.disabled = true;
        input.dataset.field = field;
        return input;
      }

      function makeCellTextarea(field, value) {
        const ta = document.createElement("textarea");
        ta.value = value == null ? "" : String(value);
        ta.disabled = true;
        ta.dataset.field = field;
        return ta;
      }

      function getRowValues(tr) {
        const vals = {};
        tr.querySelectorAll("input[data-field], textarea[data-field]").forEach((el) => {
          vals[el.dataset.field] = el.value;
        });
        return vals;
      }

      function snapshotRow(tr) {
        tr.dataset.snapshot = JSON.stringify(getRowValues(tr));
      }

      function restoreSnapshot(tr) {
        const snap = tr.dataset.snapshot ? JSON.parse(tr.dataset.snapshot) : null;
        if (!snap) return;
        tr.querySelectorAll("input[data-field], textarea[data-field]").forEach((el) => {
          const f = el.dataset.field;
          if (f === "imagen") return;
          if (Object.prototype.hasOwnProperty.call(snap, f)) el.value = snap[f];
        });
        const img = tr.querySelector("img[data-role='preview']");
        if (img && snap.imagen_actual) img.src = resolveImageSrc(snap.imagen_actual);
        const fileInput = tr.querySelector('input[type="file"][data-field="imagen"]');
        if (fileInput) fileInput.value = "";
      }

      function renderRow(p) {
        const tr = document.createElement("tr");
        tr.dataset.id = p.id;

        const tdId = document.createElement("td");
        tdId.textContent = p.id;
        tr.appendChild(tdId);

        const tdNombre = document.createElement("td");
        tdNombre.appendChild(makeCellInput("text", "nombre", p.nombre));
        tr.appendChild(tdNombre);

        const tdCat = document.createElement("td");
        tdCat.appendChild(makeCellInput("number", "id_categoria", p.id_categoria));
        tr.appendChild(tdCat);

        const tdTipo = document.createElement("td");
        tdTipo.appendChild(makeCellInput("text", "tipo", p.tipo));
        tr.appendChild(tdTipo);

        const tdStock = document.createElement("td");
        tdStock.appendChild(makeCellInput("number", "stock", p.stock));
        tr.appendChild(tdStock);

        const tdPrecio = document.createElement("td");
        tdPrecio.appendChild(makeCellInput("number", "precio", p.precio));
        tr.appendChild(tdPrecio);

        const tdDur = document.createElement("td");
        tdDur.appendChild(makeCellInput("number", "duracion_producto", p.duracion_producto));
        tr.appendChild(tdDur);

        const tdDesc = document.createElement("td");
        tdDesc.appendChild(makeCellTextarea("descripcion", p.descripcion));
        tr.appendChild(tdDesc);

        const tdImg = document.createElement("td");
        const img = document.createElement("img");
        img.className = "img";
        img.alt = "Imagen del producto";
        img.src = resolveImageSrc(p.imagen);
        img.dataset.role = "preview";
        tdImg.appendChild(img);

        const file = document.createElement("input");
        file.type = "file";
        file.accept = "image/*";
        file.disabled = true;
        file.dataset.field = "imagen";
        file.addEventListener("change", () => {
          const f = file.files && file.files[0];
          if (!f) return;
          img.src = URL.createObjectURL(f);
        });
        tdImg.appendChild(file);

        const current = document.createElement("div");
        current.className = "muted";
        current.textContent = p.imagen ? `Actual: ${p.imagen}` : "Sin imagen";
        tdImg.appendChild(current);

        // Guardamos también el nombre actual en el snapshot para restaurar la preview
        const hiddenImagenActual = document.createElement("input");
        hiddenImagenActual.type = "hidden";
        hiddenImagenActual.dataset.field = "imagen_actual";
        hiddenImagenActual.value = p.imagen || "";
        tdImg.appendChild(hiddenImagenActual);

        tr.appendChild(tdImg);

        const tdActions = document.createElement("td");
        const actions = document.createElement("div");
        actions.className = "row-actions";

        const btnEdit = document.createElement("button");
        btnEdit.textContent = "Editar";
        btnEdit.dataset.action = "edit";
        btnEdit.addEventListener("click", () => {
          errorEl.textContent = "";
          snapshotRow(tr);
          setRowEditing(tr, true);
        });

        const btnSave = document.createElement("button");
        btnSave.textContent = "Guardar";
        btnSave.className = "primary";
        btnSave.dataset.action = "save";
        btnSave.disabled = true;
        btnSave.addEventListener("click", async () => {
          errorEl.textContent = "";
          setRowBusy(tr, true);
          try {
            const values = getRowValues(tr);
            const formData = new FormData();

            formData.append("nombre", values.nombre || "");
            formData.append("id_categoria", values.id_categoria || "");
            formData.append("tipo", values.tipo || "");
            formData.append("stock", values.stock || "");
            formData.append("precio", values.precio || "");
            formData.append("descripcion", values.descripcion || "");
            formData.append("duracion_producto", values.duracion_producto || "");

            const fileInput = tr.querySelector('input[type="file"][data-field="imagen"]');
            const selectedFile = fileInput && fileInput.files ? fileInput.files[0] : null;
            if (selectedFile) {
              formData.append("imagen", selectedFile);
            } else {
              formData.append("imagen_anterior", values.imagen_actual || "");
            }

            await window.apiFetch(`/productos/${tr.dataset.id}`, "PUT", formData);

            setRowEditing(tr, false);
          } catch (err) {
            errorEl.textContent = err?.message || "No se pudo guardar el producto.";
          } finally {
            setRowBusy(tr, false);
          }
        });

        const btnCancel = document.createElement("button");
        btnCancel.textContent = "Cancelar";
        btnCancel.dataset.action = "cancel";
        btnCancel.disabled = true;
        btnCancel.addEventListener("click", () => {
          errorEl.textContent = "";
          restoreSnapshot(tr);
          setRowEditing(tr, false);
        });

        actions.appendChild(btnEdit);
        actions.appendChild(btnSave);
        actions.appendChild(btnCancel);
        tdActions.appendChild(actions);
        tr.appendChild(tdActions);

        setRowEditing(tr, false);
        snapshotRow(tr);
        return tr;
      }

      async function loadProducts() {
        errorEl.textContent = "";
        rowsEl.innerHTML = "";

        try {
          const products = await window.apiFetch("/productos");
          if (!Array.isArray(products)) {
            throw new Error("Respuesta inesperada al listar productos.");
          }

          products.forEach((p) => rowsEl.appendChild(renderRow(p)));
        } catch (err) {
          errorEl.textContent = err?.message || "No se pudo cargar la lista de productos.";
        }
      }

      loadProducts();
    </script>
  </body>
</html>

