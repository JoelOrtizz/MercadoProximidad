<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard</title>
    <link rel="stylesheet" href="../css/index.css" />
  </head>

  <body>
    <nav>
      <span>Panel principal</span>
      <button onclick="handleLogout()">Cerrar sesion</button>
    </nav>

    <h1>Bienvenido, <span id="userDisplay"></span></h1>
    <button class="btn-danger" onclick="handleDeleteMyAccount()">Eliminar mi cuenta</button>

    <h2>Lista de usuarios</h2>
    <button onclick="loadUsers()">Recargar lista</button>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Email</th>
          <th>Tipo</th>
        </tr>
      </thead>
      <tbody id="usersTableBody"></tbody>
    </table>

    <script src="../js/main.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const nickname = localStorage.getItem("user_nickname");
        document.getElementById("userDisplay").innerText = nickname || "(sin nickname)";
        loadUsers();
      });

      async function loadUsers() {
        const tbody = document.getElementById("usersTableBody");
        tbody.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';

        try {
          const data = await apiFetch("/usuarios");
          if (!data || !Array.isArray(data.users)) {
            tbody.innerHTML = '<tr><td colspan="4">Respuesta inesperada.</td></tr>';
            return;
          }

          tbody.innerHTML = "";
          data.users.forEach((user) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${user.id}</td>
              <td>${user.nombre} (${user.nickname})</td>
              <td>${user.email}</td>
              <td>${user.tipo ?? ""}</td>
            `;
            tbody.appendChild(tr);
          });
        } catch {
          tbody.innerHTML = '<tr><td colspan="4">Error cargando usuarios.</td></tr>';
        }
      }

      async function handleDeleteMyAccount() {
        if (!confirm("Seguro que quieres eliminar tu cuenta?")) return;

        try {
          await apiFetch("/usuarios/me", "DELETE");
          localStorage.removeItem("user_nickname");
          window.location.href = "login.html";
        } catch {
          // apiFetch muestra el error
        }
      }
    </script>
  </body>
</html>

